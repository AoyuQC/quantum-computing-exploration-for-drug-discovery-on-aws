
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://awslabs.github.io/quantum-ready-solution-for-drug-discovery/workshop/a-molecule-unfolding/notebook-experiment/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.8">
    
    
      
        <title>Notebook Experiment - Quantum Ready Solution for Drug Discovery</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6e60f8b8.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#background" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Quantum Ready Solution for Drug Discovery" class="md-header__button md-logo" aria-label="Quantum Ready Solution for Drug Discovery" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Quantum Ready Solution for Drug Discovery
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Notebook Experiment
            
          </span>
        </div>
      </div>
    </div>
    
    
      <div class="md-header__option">
        <div class="md-select">
          
          <button class="md-header__button md-icon" aria-label="Select language">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24z"/></svg>
          </button>
          <div class="md-select__inner">
            <ul class="md-select__list">
              
                <li class="md-select__item">
                  <a href="/mkdocs-playground/en/" hreflang="en" class="md-select__link">
                    English
                  </a>
                </li>
                
                <li class="md-select__item">
                  <a href="/mkdocs-playground/zh/" hreflang="zh" class="md-select__link">
                    中文
                  </a>
                </li>
                
            </ul>
          </div>
        </div>
      </div>
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/awslabs/quantum-ready-solution-for-drug-discovery/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Quantum Ready Solution for Drug Discovery" class="md-nav__button md-logo" aria-label="Quantum Ready Solution for Drug Discovery" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Quantum Ready Solution for Drug Discovery
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/awslabs/quantum-ready-solution-for-drug-discovery/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../cost/" class="md-nav__link">
        Cost
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/" class="md-nav__link">
        Architecture Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../security/" class="md-nav__link">
        Security
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../regions/" class="md-nav__link">
        Supported regions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../template/" class="md-nav__link">
        AWS CloudFormation template
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../deployment/" class="md-nav__link">
        Automated Deployment
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Workshop
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Workshop" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Workshop
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../background/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_2" type="checkbox" id="__nav_8_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_8_2">
          Molecule Unfolding
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Molecule Unfolding" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_2">
          <span class="md-nav__icon md-icon"></span>
          Molecule Unfolding
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../molecule-unfolding/" class="md-nav__link">
        Background
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Notebook Experiment
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../batch-test/" class="md-nav__link">
        Batch Evaluation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../test-your-own-model/" class="md-nav__link">
        Evaluate Your Own Model
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../additional-resources/" class="md-nav__link">
        Additional resources
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../uninstall/" class="md-nav__link">
        Uninstall the solution
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../source/" class="md-nav__link">
        Source code
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../revisions/" class="md-nav__link">
        Revisions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../notices/" class="md-nav__link">
        Notices
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/awslabs/quantum-ready-solution-for-drug-discovery/edit/master/docs/workshop/a-molecule-unfolding/notebook-experiment.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="background">Background</h1>
<p>Molecular Docking (MD) is an important step of the drug discovery process which aims at calculating 
the preferred position and shape of one molecule to a second when they are bound to each other. This step focuses on computationally simulating the molecular recognition process. It aims to achieve an optimized conformation for both the protein and ligand and relative orientation between protein and ligand such that the free energy of the overall system is minimized. </p>
<p><img alt="Molecular Docking" src="../../../images/molecule-docking.png" /></p>
<p>In this work, The protein or the pocket is considered as a rigid structure. The ligand is considered as a 
flexible set of atoms. There are usually three main phases in MD:</p>
<ul>
<li>Ligand expansion<ul>
<li>Identification of the rotatable bonds</li>
<li>Internal distances maximization</li>
<li>Remove tool related bias (e.g. smile-to-3D)</li>
</ul>
</li>
<li>Initial Placement<ul>
<li>Ligand main fragments decomposition</li>
<li>Ligand initial poses identification</li>
<li>Placement of the ligand into the pocket with rigid roto-translations</li>
</ul>
</li>
<li>Shape Refinement<ul>
<li>Use of the rotatable bonds to modify the ligand shape and to match the protein pocket</li>
<li>Docking score maximization</li>
</ul>
</li>
</ul>
<p>In this work, actually the first phase, ligand expansion or the molecule unfolding (MU), is focused and 
implemented using quantum annealer. This phase is important for improving docking. In fact, an initial
pose of the ligand that is set a priori may introduce shape bias affecting the final quality of the
docking. MU is the technology used for removing such initial bias.</p>
<h1 id="build-the-model">Build The Model</h1>
<h2 id="problem-definition">Problem Definition</h2>
<p>In this problem, the ligand is considered as a flexible set of atoms. Strictly speaking, 
it can be seen as a set of chemical bonds (edges). These bonds have fixed length and 
only a subset of them are rotatable. Because there are some rotatable bonds (torsions)
, the molecule is split into different disjointed fragments. Take one bond for instance, 
the rightmost rotatable one, it splits the molecule into the left and right fragments. 
These fragments can rotate independently from each other around the axis of the bond. This 
idea is graphically reported in the following figure. </p>
<p><img alt="Rotatable Bonds" src="../../../images/rotatable-bonds.png" /></p>
<p>As it indicates, the objective of MU is to find the shape of the ligand that can maximizes 
 the molecular volume. The shape of the ligand can be expressed as the unfolded shape of the
  ligand (the torsion configuration of all the rotatable bonds).</p>
<h2 id="formulation">Formulation</h2>
<p>{{% notice warning %}}</p>
<p>The original paper has some work to make the story of molecular unfolding complete:</p>
<ol>
<li>elaboration of .MOL2 file for rotatable bonds</li>
<li>the sorting method based on the betweeness centrality </li>
<li>many experiments on a ligand dataset compared with Random Search and GeoDock Search</li>
<li>dealing with the elaboration of .MOL2 file for rotatable bonds i</li>
</ol>
<p>In this workshop, we only focus on the constructing of equation for molecule unfolding and 
 the application of it in quantum annealer. We make the following assumptions:</p>
<ol>
<li>The elaboration of rotatable bonds is already finished</li>
<li>The fragment is considered as the collections of atoms with fixed space </li>
<li>The geometric center of the fragment is chosen as the distances of the atoms inside</li>
</ol>
<p>For more details, please refer to the original publication.</p>
<p>{{% /notice %}}</p>
<p>Suppose the ligand has $ M $ torsions, from $ T_i $ to $ T_M $, and each torsion must have the angle 
of rotation $\theta$.</p>
<p><img alt="Multiple Torsion" src="../../../images/multiple-torsion.png" /></p>
<p>The objective of this model is to find the unfolded torsion configuration $ {\Theta}^{unfold} $ which 
can maximizes the sum of distances $ D(\Theta) $.</p>
<p>$$ {\Theta}^{unfold} = [\theta^{unfold}_1,  \theta^{unfold}_2, ../..., \theta^{unfold}_M] $$</p>
<p>$$ D(\Theta) = \sum_{a,b}D_{a,b}(\theta)^2 $$</p>
<p>The $ D_{a,b}(\theta)^2 $ is $ || \overrightarrow{a}_0 - R(\theta)\overrightarrow{b}_0||^2  $ . 
This is the distance between fragment a and b. $ R(\theta) $ is the rotation matrix associated the torsion angle 
$ \theta $.</p>
<p><img alt="Two Frag One Tor" src="../../../images/two-frag-one-torsion.png" /></p>
<p>Since this is the problem of portfolio optimization, the final configuration can be the combination of any 
angle of any torsion. However, there are some constraints for applying it to real problem: </p>
<ol>
<li>In terms of the limitation of computation resource, the torsion cannot have the rotation with infinitely small 
precision. This means that there are limited candidates of rotation angles for each torsion. Suppose we have $ M $ 
torsions and they have the same precision of rotation angle : $ \Delta\theta $ . This means that we need $ d $ variables 
for each torsion:</li>
</ol>
<p>$$ d = \frac{2\pi}{\Delta\theta} $$
For the whole model, we need $ n = d \times M $ binary variables $ x_{ik} $ to represent all the combinations. 
For example, for the torsion $ T_i $, its torsion angle $ \theta_i $ can have $ d $ possible values:</p>
<p>$$ \theta_i = [\theta_i^1,\theta_i^2,\theta_i^3, ../..., \theta_i^d] $$</p>
<ol>
<li>If we only consider the distance, the final result or configuration may have multiple results from the same torsion as long 
as this combination means smaller distance. For example, there may be two binary variables of the same torsion, $ T_i $, in the 
final result:</li>
</ol>
<p>$$ {\Theta}^{unfold} = [\theta^2_1,  \theta^4_1, ../..., \theta^3_M] $$</p>
<p>This cannot happen in real world. $ T_1 $ can only have one of $ d $ angles finally. So we need to integrate the following constraint into our final model:</p>
<p>$$ \displaystyle\sum\limits_{k=1}^{d} x_{ik} = 1 $$</p>
<p>With these two constraints, this problem can be formulated as the high-order unconstrained binary optimization (HUBO).</p>
<p>$$ O(x_{ik}) = A\displaystyle\sum\limits_i (\displaystyle\sum\limits_{k=1}^d x_{ik}-1)^2 - \displaystyle\sum\limits_{a,b} D_{ab} (\theta)^2 $$</p>
<p>The first part is the constraint for each torsion. If one torsion has more than one angles at last, we will add the punishment term $ A $. 
However, in this implementation we calculate the distance-pair under different configuration in advance. This 
means that we use the absolute distance instead:</p>
<p>$$ O(x_{ik}) = A\displaystyle\sum\limits_i (\displaystyle\sum\limits_{k=1}^d x_{ik}-1)^2 - \displaystyle\sum\limits_{a,b} |D_{ab} (\theta)| $$</p>
<h2 id="the-code-for-model">The Code for Model</h2>
<p>We have implemented this model in <strong>protein/ligand-unfolding/ligand_unfolding.ipynb</strong>.
Suppose we have finished the parameter setting, we first initialize 
the variables using the following code:</p>
<p><img alt="Var Init" src="../../../images/var-init.png" /></p>
<p>The above code indicates that we have 4 torsions from $ x_1_? $ to $ x_4_? $. Each torsion has four optional rotation angles from $ 0^o $ to $ 270^o $. For example, $ x_3_2 $ means that the torsion 3 rotates 
$ 180^o $.</p>
<p>For constraints, we use the following code to implement: </p>
<p><img alt="Constraint" src="../../../images/constraint.png" /></p>
<p>As we analyze before, the model does not which variables belong to 
the same physical torsion. For example, $ x_1_1 , x_1_2, x_1_3 $ 
and $ x_1_4 $ belong to the same torsion. The model cannot let only 
one of them become $ 1 $. If the model choose multiple of them, we 
must punish it. As the figure shown, when the model choose more than 
one variables of $x_1_?$ to become $ 1 $, we give it the punishment 
term $ 600 $. </p>
<p>Most importantly, we use $ calc_distance_func $ to calculate
$ |D_{ab} (\theta)| $ under different $ \theta $.</p>
<p><img alt="Distance" src="../../../images/distance.png" /></p>
<h2 id="quantum-annealing">Quantum Annealing</h2>
<p>The quantum annealing (QA) can be seen as a variation of the simulated annealing (SA). Both QA and SA are meta-heuristic technique for address 
challenging combinatorial problems. QA uses the quantum fluctuation to explore the configuration space instead of thermal effects. Here, we use 
Amazon Braket API to access the Canadian company D-Wave. This annealer is implemented using superconductive qubits. Natively, the quadratic 
unconstrained binary optimization (QUBO) can be solved using quantum annealer:</p>
<p>$$ O(x) = \displaystyle\sum\limits_i h_i x_i + \displaystyle\sum_{i&gt;j} J_{i,j} x_i x_j $$</p>
<p>In QUBO form, $ x_i \in {0, 1} $ are binary variables. We can consider it as the angle that we choose for a particular torsion. $h_i$ and $J_{i,j}$
 can be considered as the values encoding the optimization task when we use corresponding angles. However, in our task, it is common that there are 
 more than one torsion between fragments, we model it as the high-order quadratic unconstrained binary optimization (HUBO) problem:</p>
<p>$$ O(x) = \displaystyle\sum\limits_i \alpha_i x_i + \displaystyle\sum_{i,j} \beta_{i,j} x_i x_j + \displaystyle\sum_{i,j,k} \gamma_{i,j,k} x_i x_j x_k + ../... $$</p>
<p><img alt="Two Frag Mul Tor" src="../../../images/two-frag-multiple-torsion.png" /></p>
<p>It is often possible to convert HUBOs to QUBOs by using some tricks, 
like adding new ancillary binary variables to replace high-order term. 
In practice, we use the API $ make _ quadratic() $ in D-Wave software package to make this conversion.</p>
<p><img alt="HUBO QUBO" src="../../../images/hubo-qubo.png" /></p>
<p>As the image shown, some high-order term of HUBO, like $ ('x_1_1','x_2_1','x_3_1') $, have been 
transformed to binary terms in QUBO. We only highlight some of them.</p>
<p>Congratulations! We have already prepared the model and it is time to test it.</p>
<h1 id="optimization">Optimization</h1>
<h2 id="adjust-parameters-for-optimization">Adjust Parameters For Optimization</h2>
<p>We have our QUBO model for experiments. There are some parameters we should define for optimization.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>penalty scalar</td>
<td>1000</td>
</tr>
<tr>
<td>hubo_qubo_val</td>
<td>energy penalty of make_quadratic()</td>
<td>5</td>
</tr>
<tr>
<td>n_c</td>
<td>number of shots for simulated annealing in local instance</td>
<td>1000</td>
</tr>
<tr>
<td>n_q</td>
<td>number of shots for quantum annealing in QPU</td>
<td>1000</td>
</tr>
<tr>
<td>M</td>
<td>number of torsions for molecule unfolding</td>
<td>[1, all the torsions]</td>
</tr>
<tr>
<td>D</td>
<td>angle precision of rotation</td>
<td>8</td>
</tr>
</tbody>
</table>
<p>We use the following code to set the parameters:</p>
<p><img alt="Parameter" src="../../../images/parameter.png" /></p>
<h2 id="run-optimizers">Run Optimizers</h2>
<p>After setting the parameters, we can run the optimization on classic device and quantum device.</p>
<h3 id="classical-optimizer-for-qubo">Classical Optimizer for QUBO</h3>
<p><img alt="Classical" src="../../../images/classical.png" /></p>
<h3 id="quantum-optimizer-for-qubo">Quantum Optimizer for QUBO</h3>
<p><img alt="Quantum" src="../../../images/quantum.png" /></p>
<h2 id="analyze-the-quality">Analyze The Quality</h2>
<p>After some time, we get the results. As the result indicates, the best answer of quantum annealer only 
occurs once.</p>
<p><img alt="OneTimeQA" src="../../../images/one-time-qa.png" /></p>
<p>This does not always indicate an error. It is actually the characteristic of the problem or how the problem 
is formulated. Because we have different linear and quadratic terms that vary by many orders of magnitude. If we 
set change value of $A$ to some smaller number, like 10 or 100, more occurrences of the best answer will be observed. 
However, these answers usually break the constraints. For more information about this phenomenon, please refer to this 
<a href="https://support.dwavesys.com/hc/en-us/community/posts/1500000698522-Number-of-occurrences-?input_string=number%20occurance">Link</a>.</p>
<p>After that, we need some postprocessing to get the results. What we really want are the desired angles of all the torsion.</p>
<p><img alt="Postprocess" src="../../../images/PostProcess.png" /></p>
<p>We test different values of $M$, and we find that when $M &gt; 5$, the quantum annealer can not embed it into its quantum circuit. When 
$M &lt; 3$, we can get comparable results from quantum annealer. In other cases, the results from the quantum annealer are not stable. 
This is interesting that we cannot get the similar results as the publication explains. Any discussion or help is welcome!</p>
<table>
<thead>
<tr>
<th>M</th>
<th>d</th>
<th>Results</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>4</td>
<td>Comparable</td>
</tr>
<tr>
<td>2</td>
<td>4</td>
<td>Comparable</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>Comparable</td>
</tr>
<tr>
<td>4</td>
<td>4</td>
<td>Not Stable</td>
</tr>
<tr>
<td>5</td>
<td>4</td>
<td>Not Stable</td>
</tr>
<tr>
<td>&gt;5</td>
<td>4</td>
<td>Not Available (Embedding Fail)</td>
</tr>
</tbody>
</table>
<h2 id="analyze-the-efficiency">Analyze The Efficiency</h2>
<p>In this workshop, we have test the efficiency of model with different complexity, $ M * d $, on different devices. We test SA on ml.c5.4xlarge, 
ml.m5.4xlarge, and ml.r5.4xlarge. We also test QA on DW_2000Q_6 and Advantage_system1.1. The result shows that, if the tasks run with the same 
number of shots (1000), the quantum annealer has really nice scaling ability for solving combinatorial problems. The Advantage_system1.1 only needs 
3 minutes to solve the QUBO model ($M=5, d=8$), while all the classic computing instance needs over 3 hours. However, there's suspicion that there is 
still much space for improvement in the SA implemented by D-Wave. More strict bench mark is needed.</p>
<p>If we change the number of shots for SA to 1, we get another group data for efficiency. </p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../molecule-unfolding/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Background" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Background
            </div>
          </div>
        </a>
      
      
        
        <a href="../batch-test/" class="md-footer__link md-footer__link--next" aria-label="Next: Batch Evaluation" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Batch Evaluation
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["tabs", "search.suggest", "search.highlight"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.22074ed6.min.js"}</script>
    
    
      <script src="../../../assets/javascripts/bundle.960e086b.min.js"></script>
      
    
  </body>
</html>